<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Derivation Graph — Formula Inline Edit</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" crossorigin="anonymous">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
  <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
  <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>
  <style>
    :root {
      color-scheme: light;
    }

    body {
      margin: 0;
      background: #f8f6f1;
      color: #1e293b;
      font-family: system-ui, sans-serif;
    }

    #cy {
      height: 100vh;
      width: 100%;
      background: #faf9f6;
      position: relative;
      overflow: hidden;
    }

    .node-box {
      position: absolute;
      background: #fffdf7;
      border: 1px solid #d8d3c3;
      border-radius: 0.75rem;
      padding: 0.65rem 0.75rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      min-width: 180px;
      transform: translate(-50%, -50%);
      transition: box-shadow 120ms ease, border-color 120ms ease;
      cursor: pointer;
    }

    .node-box.editing {
      border-color: #9b8f72;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }

    .node-formula {
      font-size: 17px;
      color: #111827;
    }

    .node-editor {
      display: none;
      margin-top: 0.4rem;
    }

    .node-box.editing .node-formula {
      display: none;
    }

    .node-box.editing .node-editor {
      display: block;
    }

    textarea.inline-edit {
      width: 100%;
      min-height: 5.5rem;
      border: 1px solid #cfc7b3;
      border-radius: 0.6rem;
      padding: 0.45rem 0.55rem;
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.95rem;
      resize: vertical;
      background: #fefdfa;
      color: #1f2937;
      box-sizing: border-box;
    }

    textarea.inline-edit:focus {
      outline: 2px solid #bfa96c;
      outline-offset: 0;
    }

    .edit-hint {
      margin-top: 0.35rem;
      font-size: 0.75rem;
      color: #6b7280;
    }

    .edit-actions {
      margin-top: 0.45rem;
      display: flex;
      justify-content: flex-end;
      gap: 0.4rem;
    }

    .edit-actions button {
      border: 1px solid #b8a66a;
      background: #f5e9c9;
      color: #544216;
      border-radius: 0.5rem;
      padding: 0.25rem 0.8rem;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
    }

    .edit-actions button.cancel {
      border-color: #d1d5db;
      background: #f3f4f6;
      color: #374151;
    }

    .edit-actions button:hover {
      filter: brightness(0.97);
    }
  </style>
</head>
<body>
  <div id="cy"></div>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const store = {
      nodes: [
        { id: 'def_L', latex: 'L = T - V' },
        { id: 'eq_EL', latex: '\\frac{d}{dt}\\frac{\\partial L}{\\partial \\dot q} - \\frac{\\partial L}{\\partial q} = 0' }
      ],
      edges: [
        { id: 'e1', source: 'def_L', target: 'eq_EL' }
      ]
    };

    if (typeof cytoscapeDagre === 'function') {
      cytoscape.use(cytoscapeDagre);
    }

    const cy = cytoscape({
      container: document.getElementById('cy'),
      layout: { name: 'dagre', rankDir: 'TB', nodeSep: 120, rankSep: 140 },
      style: [
        {
          selector: 'node',
          style: {
            'shape': 'round-rectangle',
            'background-opacity': 0,
            'label': 'data(latex)',
            'text-opacity': 0
          }
        },
        {
          selector: 'edge',
          style: {
            'width': 2,
            'line-color': '#cbbf9d',
            'target-arrow-color': '#cbbf9d',
            'target-arrow-shape': 'triangle'
          }
        }
      ],
      elements: {
        nodes: store.nodes.map((n) => ({ data: n })),
        edges: store.edges.map((e) => ({ data: e }))
      }
    });

    const container = cy.container();
    const nodeBoxes = new Map();
    let activeEditor = null;

    function renderLatex(target, latex) {
      try {
        target.innerHTML = katex.renderToString(latex, { throwOnError: false });
      } catch (err) {
        target.textContent = latex;
      }
    }

    function positionBox(node, box) {
      if (!box) return;
      const pos = node.renderedPosition();
      box.style.left = pos.x + 'px';
      box.style.top = pos.y + 'px';
    }

    function updatePositions() {
      cy.nodes().forEach((node) => {
        const state = nodeBoxes.get(node.id());
        if (state) {
          positionBox(node, state.wrapper);
        }
      });
    }

    function createBox(node) {
      const wrapper = document.createElement('div');
      wrapper.className = 'node-box';

      const preview = document.createElement('div');
      preview.className = 'node-formula';
      const initialLatex = node.data('latex');
      renderLatex(preview, initialLatex);

      const editor = document.createElement('div');
      editor.className = 'node-editor';

      const textarea = document.createElement('textarea');
      textarea.className = 'inline-edit';
      textarea.value = initialLatex;

      const hint = document.createElement('div');
      hint.className = 'edit-hint';
      hint.textContent = 'Save with Ctrl/Cmd + Enter · Cancel with Esc';

      const actions = document.createElement('div');
      actions.className = 'edit-actions';

      const saveBtn = document.createElement('button');
      saveBtn.type = 'button';
      saveBtn.textContent = 'Save';

      const cancelBtn = document.createElement('button');
      cancelBtn.type = 'button';
      cancelBtn.textContent = 'Cancel';
      cancelBtn.className = 'cancel';

      actions.appendChild(cancelBtn);
      actions.appendChild(saveBtn);

      editor.appendChild(textarea);
      editor.appendChild(hint);
      editor.appendChild(actions);

      wrapper.appendChild(preview);
      wrapper.appendChild(editor);
      container.appendChild(wrapper);

      positionBox(node, wrapper);

      const state = {
        wrapper,
        preview,
        editor,
        textarea,
        mode: 'view',
        savedLatex: initialLatex,
        draftLatex: initialLatex,
        enterEdit,
        exitEdit
      };

      function enterEdit() {
        if (state.mode === 'edit') return;
        if (activeEditor && activeEditor !== state) {
          activeEditor.exitEdit(true);
        }
        state.mode = 'edit';
        activeEditor = state;
        wrapper.classList.add('editing');
        textarea.value = state.draftLatex;
        setTimeout(() => {
          textarea.focus();
          textarea.setSelectionRange(textarea.value.length, textarea.value.length);
        }, 0);
      }

      function exitEdit(saveChanges) {
        if (state.mode !== 'edit') return;
        if (saveChanges) {
          const next = state.draftLatex;
          if (next !== state.savedLatex) {
            state.savedLatex = next;
            node.data('latex', next);
            renderLatex(preview, next);
          }
          state.draftLatex = state.savedLatex;
          textarea.value = state.savedLatex;
        } else {
          state.draftLatex = state.savedLatex;
          textarea.value = state.savedLatex;
        }
        state.mode = 'view';
        wrapper.classList.remove('editing');
        if (activeEditor === state) {
          activeEditor = null;
        }
      }

      wrapper.addEventListener('click', (event) => {
        event.stopPropagation();
        enterEdit();
      });

      saveBtn.addEventListener('click', (event) => {
        event.stopPropagation();
        exitEdit(true);
      });

      cancelBtn.addEventListener('click', (event) => {
        event.stopPropagation();
        exitEdit(false);
      });

      textarea.addEventListener('keydown', (event) => {
        if ((event.key === 'Enter' && (event.metaKey || event.ctrlKey))) {
          event.preventDefault();
          exitEdit(true);
        }
        if (event.key === 'Escape') {
          event.preventDefault();
          exitEdit(false);
        }
      });

      textarea.addEventListener('input', () => {
        state.draftLatex = textarea.value;
      });

      return state;
    }

    cy.nodes().forEach((node) => {
      nodeBoxes.set(node.id(), createBox(node));
    });

    cy.on('position', 'node', (evt) => {
      const state = nodeBoxes.get(evt.target.id());
      if (state) {
        positionBox(evt.target, state.wrapper);
      }
    });

    cy.on('pan zoom', updatePositions);
    cy.on('render', updatePositions);
    window.addEventListener('resize', updatePositions);

    document.addEventListener('click', (event) => {
      if (activeEditor && !activeEditor.wrapper.contains(event.target)) {
        activeEditor.exitEdit(true);
      }
    });
  });
  </script>
</body>
</html>
